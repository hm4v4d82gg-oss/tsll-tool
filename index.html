<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ§“æ¡¿æˆ°è¡“å„€è¡¨æ¿ V4 (å«ç¸¾æ•ˆçµ±è¨ˆ)</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --accent: #2962ff;
            --success: #00c853;
            --danger: #ff3d00;
            --warning: #ffab00;
            --info: #00b0ff;
            --border: #333;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container { max-width: 600px; margin: 0 auto; padding-bottom: 80px; }
        h1 { text-align: center; margin-bottom: 20px; color: var(--text-main); font-size: 1.5rem; }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .input-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 5px; color: var(--text-sub); font-size: 0.85rem; }
        input {
            width: 100%; padding: 12px; background: #2c2c2c;
            border: 1px solid #444; border-radius: 8px; color: white;
            font-size: 1rem; box-sizing: border-box;
        }
        input:focus { border-color: var(--accent); outline: none; }
        
        button {
            width: 100%; padding: 14px; border: none; border-radius: 8px;
            font-size: 1rem; cursor: pointer; font-weight: bold;
            color: white; transition: opacity 0.2s; margin-top: 5px;
        }
        .btn-fetch { background-color: #6200ea; margin-bottom: 15px; } 
        .btn-calc { background-color: var(--accent); }
        .btn-record { background-color: var(--success); margin-top: 15px; }
        .btn-danger { background-color: var(--danger); font-size: 0.8rem; padding: 8px; width: auto; }
        button:hover { opacity: 0.9; }
        button:disabled { background-color: #444; cursor: not-allowed; color: #888; }

        /* Status Grid */
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .status-item { background: #252525; padding: 12px; border-radius: 10px; text-align: center; }
        .status-label { font-size: 0.75rem; color: var(--text-sub); display: block; }
        .status-value { font-size: 1.3rem; font-weight: bold; display: block; margin-top: 4px; }
        .val-green { color: var(--success); }
        .val-red { color: var(--danger); }
        
        /* Action Banner */
        .action-banner {
            padding: 15px; border-radius: 8px; text-align: center;
            font-weight: bold; font-size: 1.2rem; margin-top: 10px; display: none;
        }
        .action-safe { background: rgba(0, 200, 83, 0.2); color: var(--success); border: 1px solid var(--success); }
        .action-danger { background: rgba(255, 61, 0, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .action-warning { background: rgba(255, 171, 0, 0.2); color: var(--warning); border: 1px solid var(--warning); }

        .logic-text {
            margin-top:15px; font-size:0.9rem; color:#aaa; padding: 12px; 
            background: #252525; border-radius: 8px; word-break: break-all;
        }

        /* Next Step & History */
        .section-title {
            margin-top: 30px; margin-bottom: 10px; font-size: 1.1rem; font-weight: bold; border-left: 4px solid var(--accent); padding-left: 10px;
        }
        
        /* Table Style */
        .history-table {
            width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px;
        }
        .history-table th { text-align: left; color: var(--text-sub); padding: 8px; border-bottom: 1px solid var(--border); }
        .history-table td { padding: 8px; border-bottom: 1px solid #2a2a2a; color: #ccc; }
        .history-pnl.positive { color: var(--success); }
        .history-pnl.negative { color: var(--danger); }
        
        .stats-summary {
            display: flex; gap: 15px; background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 15px;
        }
        .stat-box { flex: 1; text-align: center; }
        .stat-val { font-size: 1.2rem; font-weight: bold; display: block; }
        .stat-lbl { font-size: 0.8rem; color: var(--text-sub); }

        .loader { border: 3px solid #333; border-top: 3px solid #fff; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Tab Buttons */
        .tab-container { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { background: #2c2c2c; padding: 10px; flex: 1; text-align: center; cursor: pointer; border-radius: 8px; color: #888; }
        .tab-btn.active { background: var(--accent); color: white; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“Š æˆ°è¡“å„€è¡¨æ¿ V4</h1>

    <!-- Tabs -->
    <div class="tab-container">
        <div class="tab-btn active" onclick="switchTab('dashboard')">ğŸ“ˆ è¨ºæ–·é¢æ¿</div>
        <div class="tab-btn" onclick="switchTab('history')">ğŸ“ äº¤æ˜“ç´€éŒ„</div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard">
        <div class="card">
            <div class="input-row">
                <div class="input-group">
                    <label>æ¨™çš„ä»£ç¢¼ (Ticker)</label>
                    <input type="text" id="tickerSymbol" value="TSLL" style="text-transform:uppercase; font-weight:bold;">
                </div>
                <div class="input-group">
                    <label>è²·é€²æ—¥æœŸ</label>
                    <input type="date" id="entryDate">
                </div>
            </div>
            <div class="input-row">
                <div class="input-group">
                    <label>æˆæœ¬ (Cost)</label>
                    <input type="number" id="costPrice" placeholder="100.0" step="0.01">
                </div>
                <div class="input-group">
                    <label>è‚¡æ•¸ (Shares)</label>
                    <input type="number" id="sharesCount" placeholder="200">
                </div>
            </div>
            
            <button onclick="fetchData()" class="btn-fetch" id="fetchBtn">ğŸ“¡ è‡ªå‹•æŠ“å–ç¾åƒ¹</button>
            <div id="fetchMsg" style="font-size:0.8rem; color:#888; margin-bottom:15px; text-align:center;"></div>

            <div class="input-row">
                <div class="input-group">
                    <label>å€é–“æœ€é«˜åƒ¹</label>
                    <input type="number" id="highPrice" placeholder="è‡ªå‹•å¡«å…¥" step="0.01">
                </div>
                <div class="input-group">
                    <label>ç›®å‰ç¾åƒ¹</label>
                    <input type="number" id="currentPrice" placeholder="è‡ªå‹•å¡«å…¥" step="0.01">
                </div>
            </div>
            
            <button onclick="calculateStrategy()" class="btn-calc">é–‹å§‹è¨ºæ–·</button>
        </div>

        <div id="resultCard" class="card" style="display:none;">
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">æç›Šç‡</span>
                    <span id="pnlDisplay" class="status-value">--%</span>
                </div>
                <div class="status-item">
                    <span class="status-label">å¸³é¢æç›Š</span>
                    <span id="pnlValueDisplay" class="status-value">--</span>
                </div>
                <div class="status-item">
                    <span class="status-label">æŒæœ‰å¤©æ•¸</span>
                    <span id="daysDisplay" class="status-value">-- å¤©</span>
                </div>
                <div class="status-item">
                    <span class="status-label">å®‰å…¨è·é›¢</span>
                    <span id="riskDisplay" class="status-value">--%</span>
                </div>
            </div>

            <div id="actionBox" class="action-banner"></div>
            <div id="logicExplain" class="logic-text"></div>

            <!-- è¨˜éŒ„æŒ‰éˆ• -->
            <button onclick="saveTradeRecord()" class="btn-record" id="recordBtn" style="display:none;">
                ğŸ’¾ å°‡æ­¤ç­†äº¤æ˜“å­˜å…¥ç´€éŒ„
            </button>
        </div>
    </div>

    <!-- HISTORY VIEW -->
    <div id="view-history" style="display:none;">
        <div class="card">
            <div class="stats-summary">
                <div class="stat-box">
                    <span class="stat-val" id="totalPnl">$0</span>
                    <span class="stat-lbl">ç¸½ç²åˆ©</span>
                </div>
                <div class="stat-box">
                    <span class="stat-val" id="totalTrades">0</span>
                    <span class="stat-lbl">äº¤æ˜“æ¬¡æ•¸</span>
                </div>
                <div class="stat-box">
                    <span class="stat-val" id="winRate">0%</span>
                    <span class="stat-lbl">å‹ç‡</span>
                </div>
            </div>

            <div style="overflow-x:auto;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>æ¨™çš„</th>
                            <th>å‹•ä½œ</th>
                            <th>è‚¡æ•¸</th>
                            <th>å‡ºå ´åƒ¹</th>
                            <th>æç›Š</th>
                            <th>åˆªé™¤</th>
                        </tr>
                    </thead>
                    <tbody id="historyList">
                        <!-- JS will populate this -->
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button onclick="exportCSV()" style="background:#333;">ğŸ“¥ åŒ¯å‡º Excel (CSV)</button>
                <button onclick="clearHistory()" style="background:#422;">ğŸ—‘ï¸ æ¸…ç©ºç´€éŒ„</button>
            </div>
        </div>
    </div>

</div>

<script>
    // Init
    document.getElementById('entryDate').valueAsDate = new Date();
    let currentStrategyResult = null; // Store temp result for saving
    
    // Load History on startup
    refreshHistoryUI();

    function switchTab(tabName) {
        document.getElementById('view-dashboard').style.display = tabName === 'dashboard' ? 'block' : 'none';
        document.getElementById('view-history').style.display = tabName === 'history' ? 'block' : 'none';
        
        // Toggle Tab Styles
        const tabs = document.querySelectorAll('.tab-btn');
        tabs[0].classList.toggle('active', tabName === 'dashboard');
        tabs[1].classList.toggle('active', tabName === 'history');
        
        if(tabName === 'history') refreshHistoryUI();
    }

    async function fetchData() {
        const ticker = document.getElementById('tickerSymbol').value.toUpperCase().trim();
        const entryDateVal = document.getElementById('entryDate').value;
        const btn = document.getElementById('fetchBtn');
        const msg = document.getElementById('fetchMsg');
        
        if (!ticker || !entryDateVal) { alert("è³‡æ–™ä¸å®Œæ•´"); return; }

        btn.disabled = true;
        btn.innerHTML = '<div class="loader"></div> æŠ“å–ä¸­...';
        msg.innerText = `æ­£åœ¨æŠ“å– ${ticker}...`;

        try {
            const proxyUrl = "https://corsproxy.io/?";
            const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?range=3mo&interval=1d`;
            const response = await fetch(proxyUrl + encodeURIComponent(targetUrl));
            
            if (!response.ok) throw new Error("API Error");
            const data = await response.json();
            const result = data.chart.result[0];
            
            const currentPrice = result.meta.regularMarketPrice;
            const entryTs = new Date(entryDateVal).getTime() / 1000;
            const timestamps = result.timestamp;
            const highs = result.indicators.quote[0].high;
            let maxHigh = 0;
            
            if (timestamps) {
                for (let i = 0; i < timestamps.length; i++) {
                    if (timestamps[i] >= entryTs && highs[i] > maxHigh) maxHigh = highs[i];
                }
            }
            if (maxHigh === 0) maxHigh = result.meta.regularMarketDayHigh;

            document.getElementById('currentPrice').value = currentPrice.toFixed(2);
            document.getElementById('highPrice').value = maxHigh.toFixed(2);
            
            msg.innerText = "âœ… å ±åƒ¹æ›´æ–°æˆåŠŸ";
            msg.style.color = "var(--success)";
            
            if(document.getElementById('costPrice').value && document.getElementById('sharesCount').value) {
                calculateStrategy();
            }

        } catch (error) {
            console.error(error);
            msg.innerText = "âŒ æŠ“å–å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥";
            msg.style.color = "var(--danger)";
        } finally {
            btn.disabled = false;
            btn.innerText = "ğŸ“¡ è‡ªå‹•æŠ“å–ç¾åƒ¹";
        }
    }

    function calculateStrategy() {
        const ticker = document.getElementById('tickerSymbol').value.toUpperCase();
        const cost = parseFloat(document.getElementById('costPrice').value);
        const shares = parseInt(document.getElementById('sharesCount').value);
        const entryDateVal = document.getElementById('entryDate').value;
        const high = parseFloat(document.getElementById('highPrice').value);
        const current = parseFloat(document.getElementById('currentPrice').value);

        if (isNaN(cost) || isNaN(shares) || !entryDateVal || isNaN(high) || isNaN(current)) {
            alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™"); return;
        }

        const entryDate = new Date(entryDateVal);
        const today = new Date();
        const daysHeld = Math.floor((today - entryDate) / (1000 * 3600 * 24)); 
        const pnlPct = (current - cost) / cost;
        const totalValue = current * shares;
        const totalCost = cost * shares;
        const pnlValue = totalValue - totalCost;
        
        // Strategy Logic
        const stopBreakeven = cost * 1.02;
        const stopTrailing = high * 0.90;
        let activeStopPrice = high > stopBreakeven ? Math.max(stopBreakeven, stopTrailing) : cost * 0.95;
        let stopReason = high > stopBreakeven ? "ç§»å‹•åœåˆ©" : "åˆå§‹åœæ";

        // UI Updates
        document.getElementById('resultCard').style.display = 'block';
        
        const pnlEl = document.getElementById('pnlDisplay');
        pnlEl.innerText = (pnlPct * 100).toFixed(2) + "%";
        pnlEl.className = "status-value " + (pnlPct >= 0 ? "val-green" : "val-red");
        
        const pnlValEl = document.getElementById('pnlValueDisplay');
        pnlValEl.innerText = (pnlValue >= 0 ? "+" : "") + Math.round(pnlValue).toLocaleString();
        pnlValEl.style.color = pnlValue >= 0 ? "var(--success)" : "var(--danger)";

        document.getElementById('daysDisplay').innerText = daysHeld + " å¤©";
        
        const distToStop = (current - activeStopPrice) / current;
        document.getElementById('riskDisplay').innerText = (distToStop * 100).toFixed(2) + "%";

        const actionBox = document.getElementById('actionBox');
        const logicText = document.getElementById('logicExplain');
        const recordBtn = document.getElementById('recordBtn');
        
        let actionType = "HOLD"; 
        let actionMsg = "";
        let actionClass = "";
        let logicMsg = "";
        let sharesToSell = 0;

        // Logic Determination
        if (current < activeStopPrice) {
            actionType = "SELL_ALL";
            actionClass = "action-danger";
            actionMsg = "ğŸš¨ è§¸ç™¼åœæï¼šå…¨æ•¸è³£å‡º";
            logicMsg = `è·Œç ´ ${stopReason} ${activeStopPrice.toFixed(2)}`;
            sharesToSell = shares;
        } 
        else if (daysHeld >= 3 && pnlPct < 0.03 && pnlPct > -0.05) {
            actionType = "SELL_ALL";
            actionClass = "action-warning";
            actionMsg = "âš ï¸ å‹•èƒ½ä¸è¶³ï¼šå»ºè­°é›¢å ´";
            logicMsg = "3 å¤©æ¼²å¹…æœªé” 3%";
            sharesToSell = shares;
        } 
        else if (daysHeld >= 10) {
            actionType = "SELL_ALL";
            actionClass = "action-danger";
            actionMsg = "ğŸ›‘ æœŸé™å·²åˆ°ï¼šå¼·åˆ¶å‡ºå ´";
            logicMsg = "æŒæœ‰å·²é” 10 å¤©";
            sharesToSell = shares;
        } 
        else if (pnlPct >= 0.10) {
            actionType = "SELL_HALF";
            sharesToSell = Math.floor(shares / 2);
            actionClass = "action-warning";
            actionMsg = `ğŸ’° ç²åˆ©é”æ¨™ï¼šè³£å‡º ${sharesToSell} è‚¡`;
            logicMsg = "ç²åˆ© > 10%ï¼Œæ¸›ç¢¼ 50%";
        } 
        else {
            actionType = "HOLD";
            actionClass = "action-safe";
            actionMsg = "âœ… ç‹€æ…‹è‰¯å¥½ï¼šçºŒæŠ±";
            logicMsg = `å®‰å…¨å€é–“ã€‚åœæ: ${activeStopPrice.toFixed(2)}`;
        }

        actionBox.className = "action-banner " + actionClass;
        actionBox.innerText = actionMsg;
        actionBox.style.display = 'block';
        logicText.innerText = logicMsg;

        // Prepare Data for Recording
        if (actionType !== "HOLD") {
            recordBtn.style.display = 'block';
            // Calculate Realized PnL for the sold portion
            const realizedPnL = (current - cost) * sharesToSell;
            
            currentStrategyResult = {
                date: new Date().toISOString().split('T')[0],
                ticker: ticker,
                action: actionMsg.split('ï¼š')[0], // Get simple action name
                shares: sharesToSell,
                price: current,
                pnl: realizedPnL
            };
        } else {
            recordBtn.style.display = 'none';
        }
    }

    // --- HISTORY FUNCTIONS ---

    function saveTradeRecord() {
        if (!currentStrategyResult) return;
        
        // 1. Get existing history
        let history = JSON.parse(localStorage.getItem('tsll_trade_history') || "[]");
        
        // 2. Add ID
        currentStrategyResult.id = Date.now();
        
        // 3. Push new record
        history.push(currentStrategyResult);
        
        // 4. Save back
        localStorage.setItem('tsll_trade_history', JSON.stringify(history));
        
        alert("âœ… äº¤æ˜“å·²å„²å­˜ï¼è«‹è‡³ã€Œäº¤æ˜“ç´€éŒ„ã€åˆ†é æŸ¥çœ‹ã€‚");
        refreshHistoryUI();
        document.getElementById('recordBtn').style.display = 'none'; // Prevent double save
    }

    function refreshHistoryUI() {
        const history = JSON.parse(localStorage.getItem('tsll_trade_history') || "[]");
        const tbody = document.getElementById('historyList');
        tbody.innerHTML = "";

        let totalPnl = 0;
        let wins = 0;
        let totalTrades = history.length;

        // Sort by date desc
        history.sort((a, b) => b.id - a.id);

        history.forEach(item => {
            totalPnl += item.pnl;
            if (item.pnl > 0) wins++;

            const tr = document.createElement('tr');
            const pnlClass = item.pnl >= 0 ? "positive" : "negative";
            const pnlSign = item.pnl >= 0 ? "+" : "";
            
            tr.innerHTML = `
                <td>${item.date}</td>
                <td>${item.ticker}</td>
                <td style="font-size:0.8rem;">${item.action}</td>
                <td>${item.shares}</td>
                <td>${item.price}</td>
                <td class="history-pnl ${pnlClass}">${pnlSign}${Math.round(item.pnl)}</td>
                <td><button class="btn-danger" onclick="deleteRecord(${item.id})">X</button></td>
            `;
            tbody.appendChild(tr);
        });

        // Update Stats
        document.getElementById('totalPnl').innerText = "$" + Math.round(totalPnl).toLocaleString();
        document.getElementById('totalPnl').style.color = totalPnl >= 0 ? "var(--success)" : "var(--danger)";
        document.getElementById('totalTrades').innerText = totalTrades;
        document.getElementById('winRate').innerText = totalTrades > 0 ? Math.round((wins/totalTrades)*100) + "%" : "0%";
    }

    function deleteRecord(id) {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) return;
        let history = JSON.parse(localStorage.getItem('tsll_trade_history') || "[]");
        history = history.filter(item => item.id !== id);
        localStorage.setItem('tsll_trade_history', JSON.stringify(history));
        refreshHistoryUI();
    }

    function clearHistory() {
        if(!confirm("âš ï¸ è­¦å‘Šï¼šç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ­·å²ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) return;
        localStorage.removeItem('tsll_trade_history');
        refreshHistoryUI();
    }
    
    function exportCSV() {
        const history = JSON.parse(localStorage.getItem('tsll_trade_history') || "[]");
        if (history.length === 0) { alert("æ²’æœ‰ç´€éŒ„å¯åŒ¯å‡º"); return; }
        
        let csvContent = "data:text/csv;charset=utf-8,\ufeff"; // BOM for Excel
        csvContent += "æ—¥æœŸ,æ¨™çš„,å‹•ä½œ,è‚¡æ•¸,æˆäº¤åƒ¹,æç›Š\n";
        
        history.forEach(row => {
            csvContent += `${row.date},${row.ticker},${row.action},${row.shares},${row.price},${row.pnl}\n`;
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "trade_history.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>
