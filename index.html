<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V8.1</title>
    <style>
        :root { --bg-color: #121212; --card-bg: #1e1e1e; --text-main: #e0e0e0; --text-sub: #a0a0a0; --accent: #2962ff; --success: #00c853; --danger: #ff3d00; --warning: #ffab00; --info: #00b0ff; --border: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: 80px; }
        
        /* æ¥µç°¡æ¨™é¡Œæ¨£å¼ */
        h1 { text-align: center; margin-bottom: 20px; color: var(--text-sub); font-size: 2rem; font-weight: 300; letter-spacing: 2px; opacity: 0.8; }
        
        .card { background-color: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .input-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 5px; color: var(--text-sub); font-size: 0.85rem; }
        select, input { width: 100%; padding: 12px; background: #2c2c2c; border: 1px solid #444; border-radius: 8px; color: white; font-size: 1rem; box-sizing: border-box; }
        select { font-weight: bold; cursor: pointer; } input:focus, select:focus { border-color: var(--accent); outline: none; }
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: bold; color: white; transition: opacity 0.2s; margin-top: 5px; }
        .btn-fetch { background-color: #6200ea; margin-bottom: 15px; } .btn-calc { background-color: var(--accent); } .btn-record { background-color: var(--success); margin-top: 15px; } .btn-danger { background-color: var(--danger); font-size: 0.8rem; padding: 6px 10px; }
        button:hover { opacity: 0.9; } button:disabled { background-color: #444; cursor: not-allowed; color: #888; }
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .status-item { background: #252525; padding: 12px; border-radius: 10px; text-align: center; }
        .status-label { font-size: 0.75rem; color: var(--text-sub); display: block; }
        .status-value { font-size: 1.3rem; font-weight: bold; display: block; margin-top: 4px; }
        .val-green { color: var(--success); } .val-red { color: var(--danger); }
        .action-banner { padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; font-size: 1.2rem; margin-top: 10px; display: none; }
        .action-safe { background: rgba(0, 200, 83, 0.2); color: var(--success); border: 1px solid var(--success); }
        .action-danger { background: rgba(255, 61, 0, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .action-warning { background: rgba(255, 171, 0, 0.2); color: var(--warning); border: 1px solid var(--warning); }
        .logic-text { margin-top:15px; font-size:0.9rem; color:#aaa; padding: 12px; background: #252525; border-radius: 8px; word-break: break-all; }
        .ma-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 5px; vertical-align: middle; }
        .ma-up { background: rgba(0, 200, 83, 0.2); color: var(--success); border: 1px solid var(--success); } .ma-down { background: rgba(255, 61, 0, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        
        /* History Table & Tracking */
        .history-item { background: #252525; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #555; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .history-title { font-weight: bold; font-size: 1.1rem; }
        .history-date { color: #888; font-size: 0.85rem; }
        .history-details { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 0.9rem; color: #ccc; margin-bottom: 10px; }
        .pnl-pos { color: var(--success); } .pnl-neg { color: var(--danger); }
        
        /* Enhanced Next Step Box */
        .next-step { background: #1a2733; padding: 12px; border-radius: 6px; font-size: 0.9rem; margin-top: 10px; border-left: 4px solid var(--info); line-height: 1.5; }
        .next-step-title { color: var(--info); font-weight: bold; display: block; margin-bottom: 6px; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; }
        .next-step ul { margin: 0; padding-left: 20px; }
        .next-step li { margin-bottom: 4px; color: #d0d0d0; }
        
        .stats-summary { display: flex; gap: 15px; background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .stat-box { flex: 1; text-align: center; } .stat-val { font-size: 1.2rem; font-weight: bold; display: block; } .stat-lbl { font-size: 0.8rem; color: var(--text-sub); }
        .loader { border: 3px solid #333; border-top: 3px solid #fff; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-container { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { background: #2c2c2c; padding: 10px; flex: 1; text-align: center; cursor: pointer; border-radius: 8px; color: #888; }
        .tab-btn.active { background: var(--accent); color: white; font-weight: bold; }
        .chart-wrapper { height: 400px; width: 100%; margin-top: 20px; border-radius: 12px; overflow: hidden; border: 1px solid #333; }
    </style>
</head>
<body>

<div class="container">
    <h1>V8.1</h1>

    <div class="tab-container">
        <div class="tab-btn active" onclick="switchTab('dashboard')">ğŸ“ˆ è¨ºæ–· & åœ–è¡¨</div>
        <div class="tab-btn" onclick="switchTab('history')">ğŸ“ äº¤æ˜“ç´€éŒ„ & è¿½è¹¤</div>
    </div>

    <div id="view-dashboard">
        <div class="card">
            <div class="input-row">
                <div class="input-group">
                    <label>é¸æ“‡æ¨™çš„</label>
                    <select id="tickerSymbol" onchange="onTickerChange()">
                        <option value="TSLL">ğŸš— TSLL (å¯¬åœæ -12%)</option>
                        <option value="NVDL">ğŸ¤– NVDL (ç·Šåœæ -8%)</option>
                    </select>
                </div>
                <div class="input-group"><label>è²·é€²æ—¥æœŸ</label><input type="date" id="entryDate"></div>
            </div>
            <div class="input-row">
                <div class="input-group"><label>æˆæœ¬</label><input type="number" id="costPrice" placeholder="100.0" step="0.01"></div>
                <div class="input-group"><label>è‚¡æ•¸</label><input type="number" id="sharesCount" placeholder="200"></div>
            </div>
            <button onclick="fetchData()" class="btn-fetch" id="fetchBtn">ğŸ“¡ æŠ“å–æ•¸æ“šä¸¦æ›´æ–°</button>
            <div id="fetchMsg" style="font-size:0.8rem; color:#888; margin-bottom:15px; text-align:center;"></div>

            <div class="input-row" style="display:none;">
                <input type="number" id="ma5Price"> <input type="number" id="ma20Price">
            </div>
            <div class="input-row">
                <div class="input-group"><label>5æ—¥å‡ç·š <span id="ma5Badge" class="ma-badge" style="display:none;">--</span></label></div>
                <div class="input-group"><label>20æ—¥å‡ç·š <span id="ma20Badge" class="ma-badge" style="display:none;">--</span></label></div>
            </div>
            <div class="input-row">
                <div class="input-group"><label>å€é–“æœ€é«˜åƒ¹</label><input type="number" id="highPrice" placeholder="è‡ªå‹•å¡«å…¥" step="0.01"></div>
                <div class="input-group"><label>ç›®å‰ç¾åƒ¹</label><input type="number" id="currentPrice" placeholder="è‡ªå‹•å¡«å…¥" step="0.01" style="font-weight:bold;"></div>
            </div>
            <button onclick="calculateStrategy()" class="btn-calc">åŸ·è¡Œç­–ç•¥è¨ºæ–·</button>
        </div>

        <div id="resultCard" class="card" style="display:none;">
            <div class="status-grid">
                <div class="status-item"><span class="status-label">æç›Šç‡</span><span id="pnlDisplay" class="status-value">--%</span></div>
                <div class="status-item"><span class="status-label">å¸³é¢æç›Š</span><span id="pnlValueDisplay" class="status-value">--</span></div>
                <div class="status-item"><span class="status-label">æŒæœ‰å¤©æ•¸</span><span id="daysDisplay" class="status-value">-- å¤©</span></div>
                <div class="status-item"><span class="status-label">è·é›¢åœæ/åœåˆ©</span><span id="riskDisplay" class="status-value">--%</span></div>
            </div>
            <div id="actionBox" class="action-banner"></div>
            <div id="logicExplain" class="logic-text"></div>
            <button onclick="saveTradeRecord()" class="btn-record" id="recordBtn" style="display:none;">ğŸ’¾ å­˜å…¥ç´€éŒ„ä¸¦è¿½è¹¤</button>
        </div>

        <div class="card" style="padding:0; overflow:hidden;">
            <div id="tv-chart-container" class="chart-wrapper"></div>
        </div>
    </div>

    <div id="view-history" style="display:none;">
        <div class="card">
            <div class="stats-summary">
                <div class="stat-box"><span class="stat-val" id="totalPnl">$0</span><span class="stat-lbl">ç¸½ç²åˆ©</span></div>
                <div class="stat-box"><span class="stat-val" id="totalTrades">0</span><span class="stat-lbl">äº¤æ˜“æ¬¡æ•¸</span></div>
                <div class="stat-box"><span class="stat-val" id="winRate">0%</span><span class="stat-lbl">å‹ç‡</span></div>
            </div>
            
            <div id="historyListContainer"></div>

            <div style="margin-top:20px; display:flex; gap:10px;">
                <button onclick="exportCSV()" style="background:#333;">ğŸ“¥ åŒ¯å‡º Excel</button>
                <button onclick="clearHistory()" style="background:#422;">ğŸ—‘ï¸ æ¸…ç©ºç´€éŒ„</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
    document.getElementById('entryDate').valueAsDate = new Date();
    let currentStrategyResult = null; 
    refreshHistoryUI();
    setTimeout(() => { loadChart("NASDAQ:TSLL"); }, 500);

    function onTickerChange() {
        const symbol = document.getElementById('tickerSymbol').value;
        loadChart("NASDAQ:" + symbol);
        document.getElementById('currentPrice').value = "";
        document.getElementById('resultCard').style.display = 'none';
    }

    function loadChart(symbol) {
        if(document.getElementById('tv-chart-container')) {
            new TradingView.widget({
                "autosize": true, "symbol": symbol, "interval": "D", "timezone": "Asia/Taipei", "theme": "dark", "style": "1", "locale": "zh_TW", "toolbar_bg": "#f1f3f6", "enable_publishing": false, "allow_symbol_change": false, "container_id": "tv-chart-container",
                "studies": [ { id: "MASimple@tv-basicstudies", inputs: { length: 5 } }, { id: "MASimple@tv-basicstudies", inputs: { length: 20 } } ]
            });
        }
    }

    function switchTab(tabName) {
        document.getElementById('view-dashboard').style.display = tabName === 'dashboard' ? 'block' : 'none';
        document.getElementById('view-history').style.display = tabName === 'history' ? 'block' : 'none';
        const tabs = document.querySelectorAll('.tab-btn');
        tabs[0].classList.toggle('active', tabName === 'dashboard');
        tabs[1].classList.toggle('active', tabName === 'history');
        if(tabName === 'history') refreshHistoryUI();
    }

    async function fetchData() {
        const tickerEl = document.getElementById('tickerSymbol');
        const ticker = tickerEl.options[tickerEl.selectedIndex].value;
        const entryDateVal = document.getElementById('entryDate').value;
        const btn = document.getElementById('fetchBtn');
        const msg = document.getElementById('fetchMsg');
        if (!entryDateVal) { alert("è«‹é¸æ“‡è²·é€²æ—¥æœŸ"); return; }
        
        loadChart("NASDAQ:" + ticker);
        btn.disabled = true; btn.innerHTML = '<div class="loader"></div> åˆ†æä¸­...'; msg.innerText = `æ­£åœ¨åˆ†æ ${ticker}...`;

        try {
            const proxyUrl = "https://corsproxy.io/?";
            const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?range=3mo&interval=1d`;
            const response = await fetch(proxyUrl + encodeURIComponent(targetUrl));
            if (!response.ok) throw new Error("API Error");
            const data = await response.json();
            const result = data.chart.result[0];
            const prices = result.indicators.quote[0].close;
            const highs = result.indicators.quote[0].high;
            const timestamps = result.timestamp;
            const currentPrice = result.meta.regularMarketPrice;

            const getMA = (n) => {
                if (prices.length < n) return 0;
                const validPrices = prices.filter(p => p != null);
                if (validPrices.length < n) return 0;
                const slice = validPrices.slice(-n);
                return slice.reduce((a, b) => a + b, 0) / n;
            };

            const ma5 = getMA(5);
            const ma20 = getMA(20);
            const entryTs = new Date(entryDateVal).getTime() / 1000;
            let maxHigh = 0;
            if (timestamps) {
                for (let i = 0; i < timestamps.length; i++) {
                    if (timestamps[i] >= entryTs && highs[i] > maxHigh) maxHigh = highs[i];
                }
            }
            if (maxHigh === 0) maxHigh = result.meta.regularMarketDayHigh;

            document.getElementById('currentPrice').value = currentPrice.toFixed(2);
            document.getElementById('highPrice').value = maxHigh.toFixed(2);
            document.getElementById('ma5Price').value = ma5.toFixed(2);
            document.getElementById('ma20Price').value = ma20.toFixed(2);

            const ma5Badge = document.getElementById('ma5Badge'); ma5Badge.style.display = "inline-block";
            ma5Badge.innerText = currentPrice >= ma5 ? `ç«™ä¸Š` : `è·Œç ´`;
            ma5Badge.className = currentPrice >= ma5 ? "ma-badge ma-up" : "ma-badge ma-down";
            const ma20Badge = document.getElementById('ma20Badge'); ma20Badge.style.display = "inline-block";
            ma20Badge.innerText = currentPrice >= ma20 ? `å¤šé ­` : `ç©ºé ­`;
            ma20Badge.className = currentPrice >= ma20 ? "ma-badge ma-up" : "ma-badge ma-down";

            msg.innerText = "âœ… æ›´æ–°æˆåŠŸ"; msg.style.color = "var(--success)";
            if(document.getElementById('costPrice').value && document.getElementById('sharesCount').value) calculateStrategy();
        } catch (error) { console.error(error); msg.innerText = "âŒ æŠ“å–å¤±æ•—"; msg.style.color = "var(--danger)"; } finally { btn.disabled = false; btn.innerText = "ğŸ“¡ æŠ“å–æ•¸æ“šä¸¦æ›´æ–°"; }
    }

    function calculateStrategy() {
        const tickerEl = document.getElementById('tickerSymbol');
        const ticker = tickerEl.options[tickerEl.selectedIndex].value;
        const cost = parseFloat(document.getElementById('costPrice').value);
        const shares = parseInt(document.getElementById('sharesCount').value);
        const entryDateVal = document.getElementById('entryDate').value;
        const high = parseFloat(document.getElementById('highPrice').value);
        const current = parseFloat(document.getElementById('currentPrice').value);
        const ma5 = parseFloat(document.getElementById('ma5Price').value);
        const ma20 = parseFloat(document.getElementById('ma20Price').value);

        if (isNaN(cost) || isNaN(shares) || isNaN(current)) { alert("è«‹å¡«å¯«è³‡æ–™"); return; }

        const entryDate = new Date(entryDateVal);
        const today = new Date();
        const daysHeld = Math.floor((today - entryDate) / (1000 * 3600 * 24)); 
        const pnlPct = (current - cost) / cost;
        const pnlValue = (current - cost) * shares;
        
        let HARD_STOP_PCT = 0.12; 
        let TRAILING_DROP_PCT = 0.10; 
        if (ticker === "NVDL") { HARD_STOP_PCT = 0.08; TRAILING_DROP_PCT = 0.07; }

        let stopLine = 0; let stopLineReason = "";
        if (current < ma20) {
            if (current > ma5) { stopLine = ma5; stopLineReason = "ç ´ 5MA"; } 
            else { stopLine = current + 0.01; stopLineReason = "ç©ºé ­+ç ´ 5MA"; }
        } else {
            stopLine = Math.max(ma20, cost * (1 - HARD_STOP_PCT));
            stopLineReason = ma20 > cost * (1 - HARD_STOP_PCT) ? "ç ´ 20MA" : `ç¡¬åœæ -${(HARD_STOP_PCT*100)}%`;
        }

        let profitLine = 0; let profitReason = "";
        if (high > cost * 1.02) {
            const trailingStop = high * (1 - TRAILING_DROP_PCT);
            if (ma5 > 0 && ma5 > trailingStop) { profitLine = ma5; profitReason = "ç ´ 5MA"; } 
            else { profitLine = trailingStop; profitReason = `å›æª” ${(TRAILING_DROP_PCT*100)}%`; }
        }

        let activeReferencePrice = high > cost * 1.02 ? profitLine : stopLine;
        let referenceReason = high > cost * 1.02 ? profitReason : stopLineReason;

        document.getElementById('resultCard').style.display = 'block';
        const pnlEl = document.getElementById('pnlDisplay'); pnlEl.innerText = (pnlPct * 100).toFixed(2) + "%"; pnlEl.className = "status-value " + (pnlPct >= 0 ? "val-green" : "val-red");
        const pnlValEl = document.getElementById('pnlValueDisplay'); pnlValEl.innerText = (pnlValue >= 0 ? "+" : "") + Math.round(pnlValue).toLocaleString(); pnlValEl.style.color = pnlValue >= 0 ? "var(--success)" : "var(--danger)";
        document.getElementById('daysDisplay').innerText = daysHeld + " å¤©";
        const distToStop = (current - activeReferencePrice) / current; document.getElementById('riskDisplay').innerText = (distToStop * 100).toFixed(2) + "%";

        const actionBox = document.getElementById('actionBox');
        const logicText = document.getElementById('logicExplain');
        const recordBtn = document.getElementById('recordBtn');
        
        let actionType = "HOLD"; let actionMsg = ""; let actionClass = ""; let logicMsg = ""; let sharesToSell = 0;
        let nextStepHTML = "";

        if (current < ma20 && current > ma5) {
            actionType = "HOLD"; actionClass = "action-warning"; actionMsg = "âš ï¸ æ¶åå½ˆä¸­ï¼šçºŒæŠ±";
            logicMsg = `[${ticker}] ä½æ–¼ 20MA ä¸‹æ–¹ä½†ç«™ä¸Š 5MAï¼Œè¦–ç‚ºåå½ˆã€‚`;
            nextStepHTML = `<ul>
                <li><strong>é—œéµé˜²å®ˆï¼š</strong>è«‹å¯†åˆ‡é—œæ³¨ 5MA (${ma5.toFixed(2)})ã€‚</li>
                <li><strong>æ“ä½œæŒ‡å¼•ï¼š</strong>åªè¦æ”¶ç›¤è·Œç ´ 5MAï¼Œéš”æ—¥é–‹ç›¤è«‹æ¯«ä¸çŒ¶è±«å¸‚åƒ¹å‡ºæ¸…ã€‚</li>
            </ul>`;
        }
        else if (current < stopLine) {
            actionType = "SELL_ALL"; actionClass = "action-danger"; actionMsg = "ğŸš¨ è§¸ç™¼åœæï¼šå…¨æ•¸è³£å‡º";
            logicMsg = `è§¸ç™¼ï¼š${stopLineReason} (${stopLine.toFixed(2)})ã€‚`; sharesToSell = shares;
            nextStepHTML = `<ul>
                <li><strong>å†·éœæœŸï¼š</strong>ç©ºæ‰‹è§€æœ›è‡³å°‘ 2-3 å€‹äº¤æ˜“æ—¥ã€‚</li>
                <li><strong>é‡æ–°é€²å ´ï¼š</strong>ç­‰å¾…è‚¡åƒ¹é‡æ–°ç«™å› 20MA ä¸”æˆäº¤é‡æ”¾å¤§å¾Œå†è€ƒæ…®ã€‚</li>
                <li><strong>æª¢è¨ï¼š</strong>æ˜¯å¦è²·åœ¨ç©ºé ­è¶¨å‹¢ä¸­ï¼Ÿ(è‚¡åƒ¹ < 20MA æ™‚é€²å ´å‹ç‡æ¥µä½)ã€‚</li>
            </ul>`;
        }
        else if (high > cost * 1.02 && current < profitLine) {
            actionType = "SELL_ALL"; actionClass = "action-warning"; actionMsg = "ğŸ’° è§¸ç™¼åœåˆ©ï¼šå…¨æ•¸ç²åˆ©";
            logicMsg = `è§¸ç™¼ï¼š${profitReason} (${profitLine.toFixed(2)})ã€‚`; sharesToSell = shares;
            nextStepHTML = `<ul>
                <li><strong>å¿ƒæ…‹èª¿æ•´ï¼š</strong>ç²åˆ©å·²å…¥è¢‹ï¼Œåˆ‡å‹¿è¦ºå¾—è³£é£›è€Œç«‹åˆ»è¿½é«˜ã€‚</li>
                <li><strong>è§€å¯Ÿé‡é»ï¼š</strong>ç­‰å¾…è‚¡åƒ¹å›æ¸¬ 20MA ä¸ç ´ï¼Œæˆ–é‡æ–°çªç ´å‰é«˜ã€‚</li>
            </ul>`;
        }
        else if (daysHeld >= 3 && pnlPct < 0.03 && pnlPct > -0.08) {
            actionType = "SELL_ALL"; actionClass = "action-warning"; actionMsg = "âš ï¸ å‹•èƒ½ä¸è¶³ï¼šæ›è‚¡";
            logicMsg = "3 å¤©æ¼²å¹…æœªé” 3%ã€‚"; sharesToSell = shares;
            nextStepHTML = `<ul>
                <li><strong>è³‡é‡‘æ•ˆç‡ï¼š</strong>æ­¤æ¨™çš„çŸ­æœŸå‹•èƒ½ä¸è¶³ï¼Œå»ºè­°è½‰ç§»è³‡é‡‘ã€‚</li>
                <li><strong>ç¯©é¸ï¼š</strong>å°‹æ‰¾å‰›çªç ´ 20MA ä¸”å¸¶é‡çš„æ–°æ¨™çš„ã€‚</li>
            </ul>`;
        }
        else if (daysHeld >= 10) {
            actionType = "SELL_ALL"; actionClass = "action-danger"; actionMsg = "ğŸ›‘ æœŸé™å·²åˆ°ï¼šå¼·åˆ¶å‡ºå ´";
            logicMsg = "æŒæœ‰å·²é” 10 å¤©ä¸Šé™ã€‚"; sharesToSell = shares;
            nextStepHTML = `<ul>
                <li><strong>é‡ç½®é¢¨éšªï¼š</strong>ä¼‘æ¯ 1 å¤©ä»¥é‡ç½®æ§“æ¡¿è€—æé¢¨éšªã€‚</li>
                <li><strong>æ›¿ä»£æ–¹æ¡ˆï¼š</strong>è‹¥ä»çœ‹å¤šï¼Œå»ºè­°æ”¹è²·æ­£è‚¡ (ç„¡æ¯æ—¥è€—æ)ã€‚</li>
            </ul>`;
        }
        else if (pnlPct >= 0.10) {
            actionType = "SELL_HALF"; sharesToSell = Math.floor(shares / 2); actionClass = "action-warning";
            actionMsg = `ğŸ’° ç²åˆ©é”æ¨™ï¼šè³£å‡º ${sharesToSell} è‚¡`; logicMsg = "ç²åˆ© > 10%ï¼å…ˆé– 50% åˆ©æ½¤ã€‚";
            nextStepHTML = `<ul>
                <li><strong>å‰©é¤˜éƒ¨ä½ï¼š</strong>${shares - sharesToSell} è‚¡é€²å…¥ã€Œç„¡é¢¨éšªæ¨¡å¼ã€ã€‚</li>
                <li><strong>æ–°åœæï¼š</strong>å»ºè­°å°‡åœæé»ä¸Šç§»è‡³ã€Œè²·é€²æˆæœ¬åƒ¹ã€ã€‚</li>
                <li><strong>ç­–ç•¥ï¼š</strong>å‰©ä¸‹çš„éƒ¨ä½è«‹æ²¿è‘— 5MA æ“ä½œï¼Œä¸ç ´ä¸è³£ï¼Œåšå–æ³¢æ®µå¤§é­šå°¾ã€‚</li>
            </ul>`;
        }
        else {
            actionType = "HOLD"; actionClass = "action-safe"; actionMsg = "âœ… å¤šé ­çºŒæŠ±";
            logicMsg = `[${ticker}] é˜²å®ˆé»ï¼š${activeReferencePrice.toFixed(2)} (${referenceReason})`;
            nextStepHTML = `<ul>
                <li><strong>æ¯æ—¥ä»»å‹™ï¼š</strong>æ”¶ç›¤ç¢ºèªæ”¶åœ¨ 5MA ä¹‹ä¸Šã€‚</li>
                <li><strong>åŠ ç¢¼ç¦ä»¤ï¼š</strong>é™¤éçªç ´å‰é«˜ï¼Œå¦å‰‡ç¦æ­¢åœ¨ä¸‹è·Œé€”ä¸­åŠ ç¢¼ã€‚</li>
            </ul>`;
        }

        actionBox.className = "action-banner " + actionClass; actionBox.innerText = actionMsg;
        actionBox.style.display = 'block'; logicText.innerText = logicMsg;

        if (actionType !== "HOLD") {
            recordBtn.style.display = 'block';
            const realizedPnL = (current - cost) * sharesToSell;
            currentStrategyResult = {
                date: new Date().toISOString().split('T')[0], ticker: ticker,
                action: actionMsg.split('ï¼š')[0], shares: sharesToSell, price: current, pnl: realizedPnL,
                nextStep: nextStepHTML
            };
        } else { recordBtn.style.display = 'none'; }
    }

    function saveTradeRecord() { if (!currentStrategyResult) return; let h = JSON.parse(localStorage.getItem('tsll_trade_history_v8') || "[]"); currentStrategyResult.id = Date.now(); h.push(currentStrategyResult); localStorage.setItem('tsll_trade_history_v8', JSON.stringify(h)); alert("âœ… å·²å­˜å…¥"); refreshHistoryUI(); document.getElementById('recordBtn').style.display = 'none'; }
    
    function refreshHistoryUI() {
        const history = JSON.parse(localStorage.getItem('tsll_trade_history_v8') || "[]");
        const container = document.getElementById('historyListContainer'); container.innerHTML = "";
        let totalPnl = 0; let wins = 0; let totalTrades = history.length;
        history.sort((a, b) => b.id - a.id);
        
        history.forEach(item => {
            totalPnl += item.pnl; if (item.pnl > 0) wins++;
            
            const card = document.createElement('div');
            card.className = 'history-item';
            
            const pnlClass = item.pnl >= 0 ? 'pnl-pos' : 'pnl-neg';
            const pnlSign = item.pnl >= 0 ? '+' : '';
            
            card.innerHTML = `
                <div class="history-header">
                    <span class="history-title">${item.ticker} ${item.action}</span>
                    <button class="btn-danger" style="width:auto; padding:4px 8px; font-size:0.7rem;" onclick="deleteRecord(${item.id})">åˆªé™¤</button>
                </div>
                <div class="history-details">
                    <div>æ—¥æœŸ: ${item.date}</div>
                    <div>è‚¡æ•¸: ${item.shares}</div>
                    <div>åƒ¹ä½: ${item.price}</div>
                    <div style="grid-column: span 3; font-weight:bold; margin-top:5px;" class="${pnlClass}">
                        æç›Š: ${pnlSign}${Math.round(item.pnl)}
                    </div>
                </div>
                <div class="next-step">
                    <span class="next-step-title">ğŸ’¡ ä¸‹ä¸€æ­¥æˆ°è¡“æŒ‡å¼•ï¼š</span>
                    ${item.nextStep || "ç„¡æˆ°è¡“å»ºè­°"}
                </div>
            `;
            container.appendChild(card);
        });
        
        document.getElementById('totalPnl').innerText = "$" + Math.round(totalPnl).toLocaleString();
        document.getElementById('totalPnl').style.color = totalPnl >= 0 ? "var(--success)" : "var(--danger)";
        document.getElementById('totalTrades').innerText = totalTrades;
        document.getElementById('winRate').innerText = totalTrades > 0 ? Math.round((wins/totalTrades)*100) + "%" : "0%";
    }
    function deleteRecord(id) { if(confirm("åˆªé™¤ï¼Ÿ")) { let h = JSON.parse(localStorage.getItem('tsll_trade_history_v8') || "[]"); h = h.filter(i => i.id !== id); localStorage.setItem('tsll_trade_history_v8', JSON.stringify(h)); refreshHistoryUI(); }}
    function clearHistory() { if(confirm("æ¸…ç©ºï¼Ÿ")) { localStorage.removeItem('tsll_trade_history_v8'); refreshHistoryUI(); }}
    function exportCSV() { 
        const history = JSON.parse(localStorage.getItem('tsll_trade_history_v8') || "[]");
        if (history.length === 0) { alert("ç„¡ç´€éŒ„"); return; }
        // Simple CSV export without HTML tags in nextStep
        let csvContent = "data:text/csv;charset=utf-8,\ufeffæ—¥æœŸ,æ¨™çš„,å‹•ä½œ,è‚¡æ•¸,åƒ¹ä½,æç›Š\n";
        history.forEach(r => { csvContent += `${r.date},${r.ticker},${r.action},${r.shares},${r.price},${r.pnl}\n`; });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", "trade_history.csv");
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }
</script>

</body>
</html>
