<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ§“æ¡¿ ETF æˆ°è¡“å„€è¡¨æ¿ V2</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --accent: #2962ff;
            --success: #00c853;
            --danger: #ff3d00;
            --warning: #ffab00;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container { max-width: 600px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 20px; color: var(--text-main); font-size: 1.5rem; }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        /* Grid Layout for Inputs */
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: var(--text-sub); font-size: 0.85rem; }
        input {
            width: 100%; padding: 12px; background: #2c2c2c;
            border: 1px solid #444; border-radius: 8px; color: white;
            font-size: 1rem; box-sizing: border-box;
        }
        input:focus { border-color: var(--accent); outline: none; }
        
        /* Buttons */
        button {
            width: 100%; padding: 14px; border: none; border-radius: 8px;
            font-size: 1rem; cursor: pointer; font-weight: bold;
            color: white; transition: opacity 0.2s; margin-top: 5px;
        }
        .btn-fetch { background-color: #6200ea; margin-bottom: 15px; } 
        .btn-calc { background-color: var(--accent); }
        button:hover { opacity: 0.9; }
        button:disabled { background-color: #444; cursor: not-allowed; color: #888; }

        /* Status Grid */
        .status-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;
        }
        .status-item {
            background: #252525; padding: 12px; border-radius: 10px; text-align: center;
        }
        .status-label { font-size: 0.75rem; color: var(--text-sub); display: block; }
        .status-value { font-size: 1.3rem; font-weight: bold; display: block; margin-top: 4px; }
        .val-green { color: var(--success); }
        .val-red { color: var(--danger); }
        
        /* Action Banner */
        .action-banner {
            padding: 15px; border-radius: 8px; text-align: center;
            font-weight: bold; font-size: 1.2rem; margin-top: 10px; display: none;
        }
        .action-safe { background: rgba(0, 200, 83, 0.2); color: var(--success); border: 1px solid var(--success); }
        .action-danger { background: rgba(255, 61, 0, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .action-warning { background: rgba(255, 171, 0, 0.2); color: var(--warning); border: 1px solid var(--warning); }

        .logic-text {
            margin-top:15px; font-size:0.9rem; color:#aaa; padding: 12px; 
            background: #252525; border-radius: 8px; word-break: break-all;
        }
        
        .loader { border: 3px solid #333; border-top: 3px solid #fff; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸš€ æ§“æ¡¿æˆ°è¡“å„€è¡¨æ¿ V2</h1>

    <div class="card">
        <!-- ç¬¬ä¸€æ’ï¼šä»£ç¢¼èˆ‡æ—¥æœŸ -->
        <div class="input-row">
            <div class="input-group">
                <label>æ¨™çš„ä»£ç¢¼ (Ticker)</label>
                <input type="text" id="tickerSymbol" value="TSLL" style="text-transform:uppercase; font-weight:bold; letter-spacing:1px;">
            </div>
            <div class="input-group">
                <label>è²·é€²æ—¥æœŸ (Date)</label>
                <input type="date" id="entryDate">
            </div>
        </div>

        <!-- ç¬¬äºŒæ’ï¼šæˆæœ¬èˆ‡è‚¡æ•¸ -->
        <div class="input-row">
            <div class="input-group">
                <label>è²·é€²æˆæœ¬ (Cost)</label>
                <input type="number" id="costPrice" placeholder="ä¾‹å¦‚: 100.0" step="0.01">
            </div>
            <div class="input-group">
                <label>æŒæœ‰è‚¡æ•¸ (Shares)</label>
                <input type="number" id="sharesCount" placeholder="ä¾‹å¦‚: 200">
            </div>
        </div>
        
        <button onclick="fetchData()" class="btn-fetch" id="fetchBtn">
            ğŸ“¡ è‡ªå‹•æŠ“å–ç¾åƒ¹ (Yahoo API)
        </button>
        <div id="fetchMsg" style="font-size:0.8rem; color:#888; margin-bottom:15px; text-align:center;"></div>

        <!-- ç¬¬ä¸‰æ’ï¼šæŠ“å–çµæœ -->
        <div class="input-row">
            <div class="input-group">
                <label>å€é–“æœ€é«˜åƒ¹ (Max High)</label>
                <input type="number" id="highPrice" placeholder="ç³»çµ±è‡ªå‹•å¡«å…¥" step="0.01">
            </div>
            <div class="input-group">
                <label>ç›®å‰ç¾åƒ¹ (Current)</label>
                <input type="number" id="currentPrice" placeholder="ç³»çµ±è‡ªå‹•å¡«å…¥" step="0.01">
            </div>
        </div>
        
        <button onclick="calculateStrategy()" class="btn-calc">é–‹å§‹è¨ºæ–·</button>
    </div>

    <div id="resultCard" class="card" style="display:none;">
        <div class="status-grid">
            <div class="status-item">
                <span class="status-label">ç›®å‰æç›Š</span>
                <span id="pnlDisplay" class="status-value">--%</span>
            </div>
            <div class="status-item">
                <span class="status-label">å¸³é¢é‡‘é¡è®Šå‹•</span>
                <span id="pnlValueDisplay" class="status-value" style="font-size:1.1rem">--</span>
            </div>
            <div class="status-item">
                <span class="status-label">æŒæœ‰å¤©æ•¸</span>
                <span id="daysDisplay" class="status-value">-- å¤©</span>
            </div>
            <div class="status-item">
                <span class="status-label">å®‰å…¨è·é›¢</span>
                <span id="riskDisplay" class="status-value">--%</span>
            </div>
        </div>

        <div id="actionBox" class="action-banner"></div>
        <div id="logicExplain" class="logic-text"></div>
    </div>
</div>

<script>
    // é è¨­æ—¥æœŸç‚ºä»Šæ—¥
    document.getElementById('entryDate').valueAsDate = new Date();

    async function fetchData() {
        const ticker = document.getElementById('tickerSymbol').value.toUpperCase().trim();
        const entryDateVal = document.getElementById('entryDate').value;

        if (!ticker) { alert("è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼"); return; }
        if (!entryDateVal) { alert("è«‹é¸æ“‡è²·é€²æ—¥æœŸ"); return; }

        const btn = document.getElementById('fetchBtn');
        const msg = document.getElementById('fetchMsg');
        const entryTs = new Date(entryDateVal).getTime() / 1000;

        btn.disabled = true;
        btn.innerHTML = '<div class="loader"></div> é€£ç·šä¸­...';
        msg.innerText = `æ­£åœ¨æŠ“å– ${ticker} æ•¸æ“š...`;

        try {
            // CORS Proxy + Yahoo Finance API (å‹•æ…‹ä»£ç¢¼)
            const proxyUrl = "https://corsproxy.io/?";
            const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?range=3mo&interval=1d`;
            
            const response = await fetch(proxyUrl + encodeURIComponent(targetUrl));
            if (!response.ok) throw new Error("æŸ¥ç„¡æ­¤ä»£ç¢¼æˆ– API éŒ¯èª¤");
            
            const data = await response.json();
            const result = data.chart.result[0];
            
            // 1. æŠ“å–ç¾åƒ¹
            const currentPrice = result.meta.regularMarketPrice;
            
            // 2. æŠ“å–å€é–“æœ€é«˜åƒ¹
            const timestamps = result.timestamp;
            const highs = result.indicators.quote[0].high;
            let maxHigh = 0;
            
            // å›æº¯å°‹æ‰¾å¾è²·å…¥æ—¥è‡³ä»Šçš„æœ€é«˜åƒ¹
            if (timestamps) {
                for (let i = 0; i < timestamps.length; i++) {
                    if (timestamps[i] >= entryTs) {
                        if (highs[i] > maxHigh) maxHigh = highs[i];
                    }
                }
            }
            // å¦‚æœæ˜¯ä»Šå¤©å‰›è²·ï¼Œæœ€é«˜åƒ¹æš«å®šç‚ºä»Šæ—¥æœ€é«˜
            if (maxHigh === 0) maxHigh = result.meta.regularMarketDayHigh;

            // å¡«å…¥æ•¸å€¼
            document.getElementById('currentPrice').value = currentPrice.toFixed(2);
            document.getElementById('highPrice').value = maxHigh.toFixed(2);
            
            msg.innerText = `âœ… æˆåŠŸå–å¾— ${ticker} å ±åƒ¹`;
            msg.style.color = "var(--success)";
            
            // è‹¥è³‡æ–™å®Œæ•´ï¼Œè‡ªå‹•è§¸ç™¼è¨ˆç®—
            if(document.getElementById('costPrice').value && document.getElementById('sharesCount').value) {
                calculateStrategy();
            }

        } catch (error) {
            console.error(error);
            msg.innerText = `âŒ å¤±æ•—ï¼šç„¡æ³•å–å¾— ${ticker} è³‡æ–™ï¼Œè«‹æª¢æŸ¥ä»£ç¢¼æˆ–æ‰‹å‹•è¼¸å…¥ã€‚`;
            msg.style.color = "var(--danger)";
        } finally {
            btn.disabled = false;
            btn.innerText = "ğŸ“¡ è‡ªå‹•æŠ“å–ç¾åƒ¹ (Yahoo API)";
        }
    }

    function calculateStrategy() {
        // ç²å–æ‰€æœ‰æ¬„ä½
        const ticker = document.getElementById('tickerSymbol').value.toUpperCase();
        const cost = parseFloat(document.getElementById('costPrice').value);
        const shares = parseInt(document.getElementById('sharesCount').value);
        const entryDateVal = document.getElementById('entryDate').value;
        const high = parseFloat(document.getElementById('highPrice').value);
        const current = parseFloat(document.getElementById('currentPrice').value);

        // é©—è­‰
        if (isNaN(cost) || isNaN(shares) || !entryDateVal || isNaN(high) || isNaN(current)) {
            alert("è«‹ç¢ºèªã€Œæˆæœ¬ã€ã€ã€Œè‚¡æ•¸ã€èˆ‡ã€Œåƒ¹æ ¼ã€æ¬„ä½çš†å·²å¡«å¯«å®Œæ•´"); return;
        }

        // åŸºç¤è¨ˆç®—
        const entryDate = new Date(entryDateVal);
        const today = new Date();
        const daysHeld = Math.floor((today - entryDate) / (1000 * 3600 * 24)); 
        const pnlPct = (current - cost) / cost;
        const totalValue = current * shares;
        const totalCost = cost * shares;
        const pnlValue = totalValue - totalCost;
        
        // ç­–ç•¥é‚è¼¯è¨­å®š (SOP)
        const stopBreakeven = cost * 1.02; // ä¿æœ¬é»
        const stopTrailing = high * 0.90;  // ç§»å‹•åœåˆ©é» (å›æª”10%)
        
        let activeStopPrice = 0;
        let stopReason = "";

        // åˆ¤æ–·ç›®å‰é©ç”¨çš„åœåˆ©/åœæç·š
        if (high > stopBreakeven) {
             // å·²ç¶“æœ‰ç²åˆ©ï¼Œæ¡ç”¨è¼ƒåš´æ ¼çš„ä¿æœ¬æˆ–ç§»å‹•åœåˆ©
             activeStopPrice = Math.max(stopBreakeven, stopTrailing);
             stopReason = (activeStopPrice === stopBreakeven) ? "ä¿æœ¬ (Cost+2%)" : "ç§»å‹•åœåˆ© (High-10%)";
        } else {
            // é‚„åœ¨æˆæœ¬å€æ™æ‰ï¼Œæ¡ç”¨åˆå§‹åœæ
            activeStopPrice = cost * 0.95;
            stopReason = "åˆå§‹åœæ (-5%)";
        }

        // UI æ›´æ–°
        document.getElementById('resultCard').style.display = 'block';
        
        // æç›Šç™¾åˆ†æ¯”é¡¯ç¤º
        const pnlEl = document.getElementById('pnlDisplay');
        pnlEl.innerText = (pnlPct * 100).toFixed(2) + "%";
        pnlEl.className = "status-value " + (pnlPct >= 0 ? "val-green" : "val-red");
        
        // æç›Šé‡‘é¡é¡¯ç¤º
        const pnlValEl = document.getElementById('pnlValueDisplay');
        const sign = pnlValue >= 0 ? "+" : "";
        pnlValEl.innerText = `${sign}$${Math.round(pnlValue).toLocaleString()}`;
        pnlValEl.style.color = pnlValue >= 0 ? "var(--success)" : "var(--danger)";

        document.getElementById('daysDisplay').innerText = daysHeld + " å¤©";
        
        // è¨ˆç®—è·é›¢åœæé»
        const distToStop = (current - activeStopPrice) / current;
        const riskEl = document.getElementById('riskDisplay');
        riskEl.innerText = (distToStop * 100).toFixed(2) + "%";
        riskEl.style.color = distToStop < 0 ? "var(--danger)" : "#aaa";

        // æ ¸å¿ƒæ±ºç­–é‚è¼¯
        const actionBox = document.getElementById('actionBox');
        const logicText = document.getElementById('logicExplain');
        let actionClass = "", actionMsg = "", logicMsg = "";

        // 1. è§¸ç™¼åœæ
        if (current < activeStopPrice) {
            actionClass = "action-danger";
            actionMsg = "ğŸš¨ è§¸ç™¼å‡ºå ´ï¼šå…¨æ•¸è³£å‡º";
            logicMsg = `ç¾åƒ¹ ${current} å·²è·Œç ´ ${stopReason} ${activeStopPrice.toFixed(2)}ã€‚è«‹è³£å‡ºæ‰€æœ‰ ${shares} è‚¡ã€‚`;
        } 
        // 2. æ™‚é–“åœæ (3å¤©ä¸æ¼²)
        else if (daysHeld >= 3 && pnlPct < 0.03 && pnlPct > -0.05) {
            actionClass = "action-warning";
            actionMsg = "âš ï¸ å‹•èƒ½ä¸è¶³ï¼šå»ºè­°é›¢å ´";
            logicMsg = "æŒæœ‰ 3 å¤©æ¼²å¹…æœªé” 3%ï¼Œè³‡é‡‘æ•ˆç‡éä½ï¼Œå»ºè­°æ›è‚¡æ“ä½œã€‚";
        } 
        // 3. æœŸé™å¼·åˆ¶å‡ºå ´ (10å¤©)
        else if (daysHeld >= 10) {
            actionClass = "action-danger";
            actionMsg = "ğŸ›‘ æœŸé™å·²åˆ°ï¼šå¼·åˆ¶å‡ºå ´";
            logicMsg = "æŒæœ‰å·²é” 10 å¤©ä¸Šé™ï¼Œç‚ºé¿å…æ§“æ¡¿è€—æï¼Œè«‹å…¨æ•¸ç²åˆ©äº†çµã€‚";
        } 
        // 4. ç²åˆ©æ¸›ç¢¼ (10% æ¸›åŠ)
        else if (pnlPct >= 0.10) {
            const sellAmount = Math.floor(shares / 2);
            const keepAmount = shares - sellAmount;
            actionClass = "action-warning";
            actionMsg = `ğŸ’° ç²åˆ©é”æ¨™ï¼šè³£å‡º ${sellAmount} è‚¡`;
            logicMsg = `ç²åˆ©å·²è¶…é 10%ï¼SOP å»ºè­°è³£å‡º 50% (${sellAmount} è‚¡) é–ä½åˆ©æ½¤ï¼Œå‰©é¤˜ ${keepAmount} è‚¡çºŒæŠ±åšé­šå°¾ã€‚`;
        } 
        // 5. æ­£å¸¸çºŒæŠ±
        else {
            actionClass = "action-safe";
            actionMsg = "âœ… ç‹€æ…‹è‰¯å¥½ï¼šçºŒæŠ±";
            logicMsg = `ç›®å‰èµ°å‹¢å®‰å…¨ã€‚ä½ çš„ä¿è­·å‚˜ (Stop Price) ä½æ–¼ ${activeStopPrice.toFixed(2)} (${stopReason})ã€‚`;
        }

        actionBox.className = "action-banner " + actionClass;
        actionBox.innerText = actionMsg;
        actionBox.style.display = 'block';
        logicText.innerText = `è¨ºæ–·æ¨™çš„ï¼š${ticker} | ä¾æ“šï¼š${logicMsg}`;
    }
</script>

</body>
</html>
